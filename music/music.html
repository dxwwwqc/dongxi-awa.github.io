<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="https://dxwwwqc.github.io/music-assets/images/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="ä¸œæ–¹Project éšæœºéŸ³ä¹">
    <meta property="og:image" content="https://dxwwwqc.github.io/music-assets/images/favicon/android-chrome-256x256.png" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="ä¸œæ–¹Project éšæœºéŸ³ä¹">
    <meta name="msvalidate.01" content="3BDCFECA73036E90C8F629F8CC7075D7" />
    <title>ä¸œæ–¹éšæœºéŸ³ä¹</title>
    <link rel="apple-touch-icon" sizes="180x180" href="https://dxwwwqc.github.io/music-assets/images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://dxwwwqc.github.io/music-assets/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://dxwwwqc.github.io/music-assets/images/favicon/favicon-16x16.png">
    <link rel="manifest" href="https://dxwwwqc.github.io/music-assets/images/favicon/site.webmanifest">
    <link rel="mask-icon" href="https://dxwwwqc.github.io/music-assets/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="https://dxwwwqc.github.io/music-assets/images/favicon/favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.4.3/plyr.css" integrity="sha256-rufXFXaVZSvt3zXMGOG17EoglendvXvURMiR5lX9O8g="
        crossorigin="anonymous" />
    <link rel="stylesheet" href="https://dxwwwqc.github.io/music-assets/styles/styles.css">
</head>
<body id="body">
    <div id="wrapper">
        <!-- é¡¶éƒ¨ä¿¡æ¯ -->
        <div class="top">
            <div id="title">
                <span id="track">ä¸œæ–¹éšæœºéŸ³ä¹</span>
                <div id="timer">0:00</div>
                <div id="duration">0:00</div>
            </div>
            <div class="subtitle">
                <span id="series"></span>
                <p id="pid"></p>
            </div>
        </div>
        
        <!-- èƒŒæ™¯åŒºåŸŸ -->
        <div id="background">
            <!-- è§†é¢‘ -->
            <div class="plyr__video-embed fadein-2s" id="videoPlayer">
                <iframe src=""></iframe>
            </div>
        </div>

        
        <!-- è¿›åº¦æ¡ -->
        <div id="waveform">
            <canvas id="canvas"></canvas>
        </div>
        <div id="progress"></div>

        <!-- æ§åˆ¶åŒº -->
        <div class="controlsOuter">
            <div class="controlsInner">
                <div id="loading"></div>
                <i class="btn fas fa-play" id="playBtn" title="æ’­æ”¾"></i>
                <i class="btn fas fa-pause" id="pauseBtn" style="display:none;" title="æš‚åœ"></i>
                <i class="btn fas fa-step-backward" id="prevBtn" title="ä¸Šä¸€é¦–"></i>
                <i class="btn fas fa-step-forward" id="nextBtn" title="ä¸‹ä¸€é¦–"></i>
            </div>
        
            <div class="btn" id="playlistBtn" title="æ’­æ”¾åˆ—è¡¨"></div>
            <i class="btn fas fa-cog" id="settingBtn" title="è®¾ç½®"></i>
            <div class="btn" id="volumeBtn" title="éŸ³é‡"></div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="pure-menu" id="setting" style="display:none;">
            <ul class="pure-menu-list">
                <li class="pure-menu-item">
                    <div class="settingText settingTitle">MVç”Ÿæˆè®¾ç½®</div>
                </li>
                <li class="pure-menu-item">
                    <label class="settingText" for="numOfImages">å›¾ç‰‡æ•°é‡</label>
                    <select class="settingOption select" id="numOfImages">
                        <option>2</option>
                        <option>3</option>
                        <option selected>4</option>
                        <option>5</option>
                        <option>6</option>
                        <option>7</option>
                        <option>8</option>
                        <option>9</option>
                        <option>10</option>
                    </select>
                </li>
                <li class="pure-menu-item">
                    <label class="settingText" for="imagesDuration">å›¾ç‰‡æ˜¾ç¤ºæ—¶é•¿(ç§’)</label>
                    <select class="settingOption select" id="imagesDuration">
                        <option>3</option>
                        <option>4</option>
                        <option selected>5</option>
                        <option>6</option>
                        <option>7</option>
                        <option>8</option>
                        <option>9</option>
                        <option>10</option>
                    </select>
                </li>
                <li class="pure-menu-item">
                    <div class="settingText settingTitle">éŸ³é¢‘è®¾ç½®</div>
                </li>
                <li class="pure-menu-item">
                    <div class="settingText">éšæœºæ’­æ”¾</div>
                    <label class="settingOption">
                        <input type="checkbox" id="randomPlay">
                        <span class="slider"></span>
                    </label>
                </li>
                <li class="pure-menu-item">
                    <div class="settingText" title="ä½¿æ³¢å½¢å›¾åŠ¨èµ·æ¥ï¼Œåˆ‡æ¢æ­Œæ›²åç”Ÿæ•ˆã€‚">åŠ¨æ€æ³¢å½¢å›¾</div>
                    <label class="settingOption">
                        <input type="checkbox" id="animatedWaveform">
                        <span class="slider"></span>
                    </label>
                </li>
                <li class="pure-menu-item">
                    <div class="settingText" title="ä»…æ’­æ”¾æ­Œæ›²çš„å‰¯æ­Œéƒ¨åˆ†ï¼Œç„¶ååˆ‡æ¢åˆ°ä¸‹ä¸€é¦–ã€‚æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä»…å¯¹éƒ¨åˆ†æ­Œæ›²æœ‰æ•ˆã€‚">
                        ä»…å‰¯æ­Œæ¨¡å¼</div>
                    <label class="settingOption">
                        <input type="checkbox" id="chorusMode">
                        <span class="slider"></span>
                    </label>
                </li>
            </ul>
        </div>

        <!-- æ’­æ”¾åˆ—è¡¨ -->
        <div class="pure-menu pure-menu-scrollable" id="playlist" style="display:none;">
            <i class="far fa-times-circle fa-3x" id="closePlaylist" style="position:absolute;top:10px;right:10px;cursor:pointer;"></i>
            <div style="padding:20px;text-align:center;">æ’­æ”¾åˆ—è¡¨åŠ è½½ä¸­...</div>
        </div>

        <!-- éŸ³é‡æ§åˆ¶ -->
        <div id="volume" class="fadeout" style="display:none;">
            <div id="barFull" class="bar"></div>
            <div id="barEmpty" class="bar"></div>
            <div id="sliderBtn"></div>
        </div>
    </div>

    <!-- è„šæœ¬ -->
    <!-- å…ˆåŠ è½½ Firebase å¹¶ç«‹å³åˆå§‹åŒ– -->
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-database.js"></script>
    <script>
        // ç«‹å³åˆå§‹åŒ– Firebase
        var config = {
            apiKey: "AIzaSyDmPHweR82MHPChLXyOqrwOaLe8L8FyYGA",
            authDomain: "th-music-video-generator.firebaseapp.com",
            databaseURL: "https://th-music-video-generator.firebaseio.com",
            projectId: "th-music-video-generator",
            storageBucket: "th-music-video-generator.appspot.com",
            messagingSenderId: "766682158017"
        };
        firebase.initializeApp(config);
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.15/howler.core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.4.3/plyr.min.js" integrity="sha256-LAq55x/UUQNWhiFLlHHGGivmJx4sVm70ls05hcmhLQ8="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/2.0.6/wavesurfer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XZWCFGHDLB"></script>
    <script>
        // Google Analytics
        window.dataLayer = window.dataLayer || [];
        function gtag() {dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XZWCFGHDLB');
    </script>

    <!-- ä¿®å¤åçš„ JavaScript åŠŸèƒ½ -->
    <script>
        // éŸ³ä¹æ–‡ä»¶åŸºç¡€ URL - ä½¿ç”¨ GitHub Raw URL è®¿é—®éŸ³é¢‘æ–‡ä»¶
        const MUSIC_BASE_URL = 'https://dxwwwqc.github.io/music-assets';
        const AUDIO_BASE_URL = 'https://raw.githubusercontent.com/dxwwwqc/music-assets/main/';
        var googleAPI = "AIzaSyALDYJZ_19ORofWN3mcvTsMS23f8UVYCug";
        
        // å…¨å±€éŸ³é¢‘çŠ¶æ€ç®¡ç†
        var audioState = {
            currentPlaying: null,
            isPlaying: false
        };
        
        // å·¥å…·å‡½æ•°
        function mobilecheck() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // ä¿®å¤å›¾ç‰‡URLå‡½æ•°
        function fixImageUrl(url) {
            if (!url) return '';
            
            // å¤„ç†ç›¸å¯¹è·¯å¾„
            if (url.startsWith('.')) {
                url = url.substring(1);
            }
            
            // ç¡®ä¿è·¯å¾„ä»¥æ–œæ å¼€å¤´
            if (!url.startsWith('/') && !url.startsWith('http')) {
                url = '/' + url;
            }
            
            // ç¼–ç URLä½†ä¿ç•™æ–œæ 
            return encodeURI(url).replace(/%2F/g, '/');
        }

        // ä¿®æ”¹åçš„ changeImage å‡½æ•°
        function changeImage(info) {
            console.log("Changing image with info:", info);
            
            if (!info || !info.character) {
                console.error("Invalid image info:", info);
                return;
            }
            
            firebase.database().ref('images').once('value').then(function(characters) {
                let characterFound = false;
                
                if (!characters.val()) {
                    loadImageFromGoogle(info.character);
                    return;
                }
                
                characters.val().some(character => {
                    if (character.name === info.character) {
                        characterFound = true;
                        
                        if (character.images && character.images.length > 0) {
                            // éšæœºé€‰æ‹©ä¸€å¼ å›¾ç‰‡
                            const randomIndex = Math.floor(Math.random() * character.images.length);
                            let imageURL = character.images[randomIndex].path;
                            
                            // ä¿®å¤å›¾ç‰‡URL
                            imageURL = fixImageUrl(imageURL);
                            
                            // æ·»åŠ åŸºç¡€URLå‰ç¼€
                            if (!imageURL.startsWith('http')) {
                                imageURL = 'https://dxwwwqc.github.io/music-assets' + imageURL;
                            }
                            
                            console.log("Loading image:", imageURL);
                            
                            // é¢„åŠ è½½å›¾ç‰‡
                            const img = new Image();
                            img.onload = function() {
                                console.log("Image loaded successfully");
                                document.getElementById('background').style.backgroundImage = `url('${imageURL}')`;
                                document.getElementById('background').style.backgroundSize = 'cover';
                                document.getElementById('background').style.backgroundPosition = 'center';
                            };
                            img.onerror = function() {
                                console.error("Failed to load image:", imageURL);
                                // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨Googleå›¾ç‰‡æœç´¢
                                loadImageFromGoogle(info.character);
                            };
                            img.src = imageURL;
                            
                        } else {
                            console.warn("No images found for character:", info.character);
                            loadImageFromGoogle(info.character);
                        }
                        return true;
                    }
                    return false;
                });
                
                if (!characterFound) {
                    console.warn("Character not found in database:", info.character);
                    loadImageFromGoogle(info.character);
                }
                
            }).catch(function(error) {
                console.error("Firebase error:", error);
                loadImageFromGoogle(info.character);
            });
        }

        // å¤‡ç”¨å›¾ç‰‡åŠ è½½æ–¹æ¡ˆ
        function loadImageFromGoogle(character) {
            console.log("Attempting to load image from Google for:", character);
            
            const cx = '009797881502979873179:yxcz0y7drxo';
            const url = `https://www.googleapis.com/customsearch/v1/siterestrict?key=${googleAPI}&cx=${cx}&q=${encodeURIComponent(character)}&searchType=image&imgSize=large&safe=medium`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.items && data.items.length > 0) {
                        const randomIndex = Math.floor(Math.random() * data.items.length);
                        const imageURL = data.items[randomIndex].link;
                        console.log("Google image URL:", imageURL);
                        
                        document.getElementById('background').style.backgroundImage = `url('${imageURL}')`;
                        document.getElementById('background').style.backgroundSize = 'cover';
                        document.getElementById('background').style.backgroundPosition = 'center';
                    } else {
                        console.error("No Google images found for:", character);
                    }
                })
                .catch(error => {
                    console.error("Google image search failed:", error);
                });
        }
        
        function getTranslatedSong(file, lang) {
            return Promise.resolve(null);
        }
        
        function imagePreload(url) {
            var img = new Image();
            img.src = encodeURI(url);
            return img;
        }
        
        // ä¿®å¤éŸ³é¢‘URLå‡½æ•° - é€‚é…æ–°çš„ Raw GitHub URL
        function fixAudioUrl(url) {
            if (!url) return '';
            
            // å¦‚æœå·²ç»æ˜¯å®Œæ•´URLï¼Œç›´æ¥è¿”å›
            if (url.startsWith('http')) {
                return url;
            }
            
            // å¦åˆ™æ·»åŠ åŸºç¡€URL
            if (!url.startsWith('/')) {
                url = '/' + url;
            }
            
            // ç¼–ç URLä½†ä¿ç•™å¿…è¦çš„æ–œæ 
            return encodeURI(url).replace(/%2F/g, '/');
        }

        // æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        function checkAudioFileExists(url) {
            return new Promise((resolve) => {
                fetch(url, { method: 'HEAD' })
                    .then((response) => {
                        resolve(response.ok);
                    })
                    .catch(() => resolve(false));
            });
        }

        // æ¨¡æ‹Ÿ vudio.js åŠŸèƒ½
        var Vudio = function(audio, canvas, options) {
            this.audio = audio;
            this.canvas = canvas;
            this.options = options;
            this.dance = function() {
                console.log("Vudio visualization enabled");
            };
            this.setOption = function(options) {
                console.log("Vudio options updated");
            };
        };

        // å·¥å…·å‡½æ•°
        const delay = (ms) => {
            return new Promise((resolve) => {
                setTimeout(resolve, ms);
            });
        };

        function setOpacity(object, opacityPct) {
            if (object) object.style.opacity = opacityPct / 100;
        }

        function fadeInImage(foregroundId, imageURL, backgroundId, callback = undefined) {
            if (imageURL) imagePreload(imageURL);
            var foreground = document.getElementById(foregroundId);
            var background = document.getElementById(backgroundId);
            if (background && foreground) {
                background.style.backgroundImage = foreground.style.backgroundImage;
                background.style.backgroundRepeat = 'no-repeat';
            }
            setTimeout(() => {
                setOpacity(foreground, 0);
                if (foreground) {
                    foreground.style.backgroundImage = "url('" + encodeURI(imageURL) + "')";
                    setOpacity(foreground, 100);
                }
                if (callback) callback();
            }, 1000);
        }

        // å›½é™…åŒ–åŠŸèƒ½
        let cached = {};

        function getLangfile(lang) {
            return new Promise(function (resolve, reject) {
                if (cached[lang]) resolve(cached[lang]);
                firebase.database().ref('i18n').once('value')
                    .then(function (i18n) {
                        let json = i18n.val()[lang];
                        // å¤„ç†JSONæ•°æ®
                        let res = {};
                        for (let property in json) {
                            res[property] = json[property];
                        }
                        cached[lang] = res;
                        resolve(res);
                    })
                    .catch(reject);
            });
        }

        // å…¨å±€å˜é‡
        var songList = [];
        var player = null;
        var vudio;
        var wavesurfer;
        var chorusFlag = false;

        // å®‰å…¨çš„æ’­æ”¾å™¨è°ƒç”¨å‡½æ•°
        function safePlayerCall(callback) {
            if (player) {
                callback();
            } else {
                console.log("æ’­æ”¾å™¨å°šæœªåˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•");
            }
        }

        // å®‰å…¨çš„è°ƒæ•´å¤§å°å‡½æ•°
        function safeResize() {
            if (!player || !waveform) return;
            
            var width = waveform.clientWidth || 800;
            var height = (window.innerHeight > 0) ? window.innerHeight * 0.2 : 100;
            if (waveform) {
                waveform.style.bottom = (height * 0.1 + 90) + 'px';
            }
            if (canvas) {
                canvas.width = width;
                canvas.height = height;
            }
        }

        // è°ƒè¯•å‡½æ•° - æµ‹è¯•å›¾ç‰‡åŠ è½½
        function testImageLoad(characterName) {
            console.log("Testing image load for:", characterName);
            firebase.database().ref('images').once('value').then(function(characters) {
                console.log("All characters:", characters.val());
                
                let found = false;
                characters.val().some(character => {
                    if (character.name === characterName) {
                        console.log("Found character:", character);
                        console.log("Images:", character.images);
                        found = true;
                        
                        if (character.images) {
                            character.images.forEach((img, index) => {
                                let testUrl = fixImageUrl(img.path);
                                if (!testUrl.startsWith('http')) {
                                    testUrl = 'https://dxwwwqc.github.io/music-assets' + testUrl;
                                }
                                console.log(`Image ${index}:`, testUrl);
                            });
                        }
                        return true;
                    }
                    return false;
                });
                
                if (!found) {
                    console.log("Character not found in database");
                }
            }).catch(error => {
                console.error("Firebase error:", error);
            });
        }

        // åœ¨æ§åˆ¶å°ä¸­å¯ä»¥è°ƒç”¨ testImageLoad('ã‚¢ãƒªã‚¹ãƒ»ãƒãƒ¼ã‚¬ãƒˆãƒ­ã‚¤ãƒ‰') æ¥æµ‹è¯•
        window.testImageLoad = testImageLoad;
    </script>

    <!-- ä¿®å¤åçš„æ’­æ”¾å™¨é€»è¾‘ -->
    <script>
        // Cache references to DOM elements.
        var elms = ['track', 'timer', 'duration', 'playBtn', 'pauseBtn', 'prevBtn', 'nextBtn', 'settingBtn', 'playlistBtn', 'volumeBtn', 'progress', 'waveform', 'canvas', 'loading', 'playlist', 'volume', 'barEmpty', 'barFull', 'sliderBtn'];
        elms.forEach(function (elm) {
            window[elm] = document.getElementById(elm);
        });

        // For Japanese title cache
        let jpGameTitles = [];
        let jpSongTitles = [];

        /**
         * Player class
         */
        var Player = function (playlist) {
            this.playlist = playlist;
            this.index = 0;

            // å°è¯•ä»URLè·å–ç´¢å¼•ï¼Œå¦åˆ™éšæœºé€‰æ‹©
            var url = new URL(window.location.href);
            var parser = new URLSearchParams(url.search);
            var parserIndex = parseInt(parser.get('index'));
            
            if (!isNaN(parserIndex) && parserIndex < playlist.length && parserIndex >= 0) {
                this.index = parserIndex;
            } else {
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„æ­Œæ›²ç´¢å¼•
                for (let i = 0; i < playlist.length; i++) {
                    if (playlist[i].file != null) {
                        this.index = i;
                        break;
                    }
                }
            }

            // æ˜¾ç¤ºåˆå§‹ä¿¡æ¯
            if (track && playlist[this.index]) {
                track.innerHTML = playlist[this.index].title || 'ä¸œæ–¹éšæœºéŸ³ä¹';
            }

            // åˆ›å»ºæ’­æ”¾åˆ—è¡¨UI
            this.createPlaylistUI();
        };

        Player.prototype = {
            lang: 'jp',
            
            /**
             * ğŸ”´ ä¿®å¤ï¼šåœæ­¢æ‰€æœ‰éŸ³é¢‘çš„æ–¹æ³•
             */
            stopAllSounds: function() {
                var self = this;
                console.log("ğŸ›‘ Stopping all sounds...");
                
                // éå†æ’­æ”¾åˆ—è¡¨ï¼Œåœæ­¢æ‰€æœ‰ Howl å®ä¾‹
                if (self.playlist) {
                    self.playlist.forEach(function(song) {
                        if (song.howl) {
                            try {
                                if (song.howl.playing && song.howl.playing()) {
                                    console.log("Stopping song:", song.title);
                                    song.howl.stop();
                                }
                            } catch (error) {
                                console.log("Error stopping sound:", error);
                            }
                        }
                    });
                }
                
                // é‡ç½®éŸ³é¢‘çŠ¶æ€
                audioState.isPlaying = false;
                audioState.currentPlaying = null;
            },
            
            createPlaylistUI: function() {
                if (!playlist) return;
                
                var pl = document.getElementById('playlist');
                pl.innerHTML = '<i class="far fa-times-circle fa-3x" id="closePlaylist" style="position:absolute;top:10px;right:10px;cursor:pointer;"></i>';
                
                var ul = document.createElement('ul');
                ul.className = 'pure-menu-list';
                
                this.playlist.forEach((song, index) => {
                    var li = document.createElement('li');
                    li.className = 'pure-menu-item';
                    
                    if (song.file == null) {
                        // æ¸¸æˆæ ‡é¢˜
                        li.innerHTML = song.title;
                        li.className += ' pure-menu-disabled playlist-title';
                    } else {
                        // æ­Œæ›²
                        var a = document.createElement('div');
                        a.innerHTML = song.title;
                        a.className = 'pure-menu-link playlist-item';
                        a.onclick = () => {
                            if (player) player.skipTo(index);
                        };
                        li.appendChild(a);
                    }
                    ul.appendChild(li);
                });
                
                pl.appendChild(ul);
                
                // é‡æ–°ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
                var closeBtn = document.getElementById('closePlaylist');
                if (closeBtn) {
                    closeBtn.onclick = () => this.togglePlaylist();
                }
            },

            /**
             * æ’­æ”¾æ­Œæ›²
             */
            play: async function (index) {
                var self = this;
                
                index = typeof index === 'number' ? index : self.index;
                
                if (index < 0 || index >= self.playlist.length) {
                    console.error("Invalid index:", index);
                    return;
                }
                
                var data = self.playlist[index];
                if (!data || data.file == null) {
                    self.skip('next');
                    return;
                }

                // ğŸ”´ ä¿®å¤ï¼šåªåœ¨éœ€è¦æ—¶åœæ­¢å…¶ä»–éŸ³é¢‘
                if (audioState.isPlaying && audioState.currentPlaying !== self) {
                    self.stopAllSounds();
                }

                // æ›´æ–°URL
                var url = new URL(window.location.href);
                var parser = new URLSearchParams(url.search);
                parser.set('index', index);
                history.replaceState(null, '', '?' + parser.toString());

                // åœæ­¢å½“å‰æ­Œæ›²
                if (self.playlist[self.index] && self.playlist[self.index].howl) {
                    self.playlist[self.index].howl.stop();
                }

                self.index = index;

                // ä½¿ç”¨å·²ç»æ„å»ºå¥½çš„å®Œæ•´éŸ³é¢‘URL
                var musicUrl = data.file;

                console.log("Attempting to load audio:", musicUrl);

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                if (loading) loading.style.display = 'block';
                if (playBtn) playBtn.style.display = 'none';
                if (pauseBtn) pauseBtn.style.display = 'none';

                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                const fileExists = await checkAudioFileExists(musicUrl);
                if (!fileExists) {
                    console.error("Audio file not found:", musicUrl);
                    if (loading) loading.style.display = 'none';
                    self.skip('next');
                    return;
                }

                // åˆ›å»ºHowlå®ä¾‹
                try {
                    sound = data.howl = new Howl({
                        src: [musicUrl],
                        html5: true,
                        format: ['mp3'],
                        onplay: function () {
                            console.log("ğŸµ Playback started successfully");
                            // æ›´æ–°éŸ³é¢‘çŠ¶æ€
                            audioState.isPlaying = true;
                            audioState.currentPlaying = self;
                            
                            if (duration) {
                                duration.innerHTML = self.formatTime(Math.round(sound.duration()));
                            }
                            requestAnimationFrame(self.step.bind(self));
                            if (pauseBtn) pauseBtn.style.display = 'block';
                            if (loading) loading.style.display = 'none';
                        },
                        onload: function () {
                            console.log("âœ… Audio loaded successfully");
                            if (loading) loading.style.display = 'none';
                            // è‡ªåŠ¨å¼€å§‹æ’­æ”¾
                            console.log("ğŸµ Starting playback...");
                            sound.play();
                        },
                        onloaderror: function(id, error) {
                            console.error("âŒ Audio load error:", error, "for URL:", musicUrl);
                            if (loading) loading.style.display = 'none';
                            setTimeout(() => self.skip('next'), 500);
                        },
                        onplayerror: function(id, error) {
                            console.error("âŒ Playback error:", error);
                            if (loading) loading.style.display = 'none';
                            // å°è¯•æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡
                            forceResumeAudioContext();
                            setTimeout(() => self.skip('next'), 500);
                        },
                        onend: function () {
                            console.log("â­ï¸ Playback ended");
                            audioState.isPlaying = false;
                            self.skip('next');
                        },
                        onpause: function () {
                            console.log("â¸ï¸ Playback paused");
                            audioState.isPlaying = false;
                        },
                        onstop: function () {
                            console.log("â¹ï¸ Playback stopped");
                            audioState.isPlaying = false;
                        }
                    });

                    // å¼€å§‹åŠ è½½éŸ³é¢‘
                    console.log("ğŸ“¥ Loading audio...");
                    sound.load();

                } catch (error) {
                    console.error("âŒ Error creating Howl instance:", error);
                    if (loading) loading.style.display = 'none';
                    setTimeout(() => self.skip('next'), 500);
                }

                // æ›´æ–°ç•Œé¢
                this.updateTitle(index);
                if (track) track.innerHTML = data.title;
                
                // æ›´æ–°æ¸¸æˆåå’ŒPIDæ˜¾ç¤º
                this.updateGameInfo(index);
                
                // åŠ è½½å›¾ç‰‡
                if (data.info) {
                    changeImage(data.info);
                }
            },

            /**
             * æ›´æ–°æ¸¸æˆåå’ŒPIDä¿¡æ¯
             */
            updateGameInfo: function(index) {
                var self = this;
                
                // æŸ¥æ‰¾å½“å‰æ­Œæ›²æ‰€å±çš„æ¸¸æˆ
                var currentGameIndex = -1;
                for (var i = index; i >= 0; i--) {
                    if (self.playlist[i].file == null) {
                        // æ‰¾åˆ°æ¸¸æˆæ ‡é¢˜é¡¹
                        currentGameIndex = i;
                        break;
                    }
                }
                
                // æ›´æ–°æ¸¸æˆåæ˜¾ç¤º
                if (series && currentGameIndex >= 0 && self.playlist[currentGameIndex]) {
                    series.innerHTML = self.playlist[currentGameIndex].title;
                }
                
                // æ›´æ–°PIDæ˜¾ç¤º
                if (pid && self.playlist[index].info) {
                    var pidText = self.playlist[index].info.pid || '';
                    pid.innerHTML = pidText;
                }
            },

            /**
             * æš‚åœ
             */
            pause: function () {
                var self = this;
                var sound = self.playlist[self.index] && self.playlist[self.index].howl;
                if (sound) {
                    sound.pause();
                    // æ›´æ–°éŸ³é¢‘çŠ¶æ€
                    audioState.isPlaying = false;
                    if (playBtn) playBtn.style.display = 'block';
                    if (pauseBtn) pauseBtn.style.display = 'none';
                }
            },

            /**
             * åœæ­¢å½“å‰éŸ³é¢‘
             */
            stop: function() {
                var self = this;
                var sound = self.playlist[self.index] && self.playlist[self.index].howl;
                
                if (sound) {
                    sound.stop();
                }
                
                audioState.isPlaying = false;
                
                // æ˜¾ç¤ºæ’­æ”¾æŒ‰é’®
                if (playBtn) playBtn.style.display = 'block';
                if (pauseBtn) pauseBtn.style.display = 'none';
            },

            /**
             * åˆ‡æ¢æ­Œæ›²
             */
            skip: function (direction) {
                var self = this;
                var newIndex = self.index;

                if (direction === 'prev') {
                    newIndex = self.index - 1;
                    if (newIndex < 0) newIndex = self.playlist.length - 1;
                } else {
                    newIndex = self.index + 1;
                    if (newIndex >= self.playlist.length) newIndex = 0;
                }

                // æ‰¾åˆ°æœ‰æ•ˆçš„æ­Œæ›²ç´¢å¼•
                var attempts = 0;
                while (attempts < self.playlist.length) {
                    if (self.playlist[newIndex] && self.playlist[newIndex].file != null) {
                        break;
                    }
                    newIndex = direction === 'prev' ? newIndex - 1 : newIndex + 1;
                    if (newIndex < 0) newIndex = self.playlist.length - 1;
                    if (newIndex >= self.playlist.length) newIndex = 0;
                    attempts++;
                }

                self.skipTo(newIndex);
            },

            skipTo: function (index) {
                var self = this;
                if (index >= 0 && index < self.playlist.length) {
                    if (self.playlist[self.index] && self.playlist[self.index].howl) {
                        self.playlist[self.index].howl.stop();
                    }
                    self.play(index);
                }
            },

            /**
             * éŸ³é‡æ§åˆ¶ - æ”¹å›åˆå§‹ç‰ˆæœ¬
             */
            volume: function (val) {
                var self = this;

                // Update the global volume (affecting all Howls).
                Howler.volume(val);

                // Update the display on the slider.
                var barWidth = (val * 90) / 100;
                barFull.style.width = (barWidth * 100) + '%';
                sliderBtn.style.left = (window.innerWidth * barWidth + window.innerWidth * 0.05 - 25) + 'px';
            },

            /**
             * è¿›åº¦æ§åˆ¶
             */
            seek: function (per) {
                var self = this;
                var sound = self.playlist[self.index] && self.playlist[self.index].howl;
                if (sound && sound.duration()) {
                    sound.seek(sound.duration() * per);
                }
            },

            /**
             * æ›´æ–°è¿›åº¦
             */
            step: function () {
                var self = this;
                var sound = self.playlist[self.index] && self.playlist[self.index].howl;
                
                if (sound && sound.playing()) {
                    var seek = sound.seek() || 0;
                    if (timer) timer.innerHTML = self.formatTime(Math.round(seek));
                    if (progress) {
                        var progressPercent = (seek / sound.duration()) * 100;
                        progress.style.width = progressPercent + '%';
                    }
                    requestAnimationFrame(self.step.bind(self));
                }
            },

            /**
             * ç•Œé¢æ§åˆ¶
             */
            togglePlaylist: function () {
                if (!playlist) return;
                var isVisible = playlist.style.display === 'block';
                playlist.style.display = isVisible ? 'none' : 'block';
            },

            toggleVolume: function () {
                if (!volume) return;
                var isVisible = volume.style.display === 'block';
                volume.style.display = isVisible ? 'none' : 'block';
            },

            toggleSetting: function () {
                if (!setting) return;
                var isVisible = setting.style.display === 'block';
                setting.style.display = isVisible ? 'none' : 'block';
            },

            /**
             * å·¥å…·å‡½æ•°
             */
            formatTime: function (secs) {
                var minutes = Math.floor(secs / 60) || 0;
                var seconds = (secs - minutes * 60) || 0;
                return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            },

            updateTitle: function() {
                if (!this.playlist[this.index] || !track) return;
                track.innerHTML = this.playlist[this.index].title;
            }
        };

        // éŸ³é¢‘ä¸Šä¸‹æ–‡æ¢å¤å‡½æ•°
        function forceResumeAudioContext() {
            if (Howler.ctx && Howler.ctx.state === 'suspended') {
                console.log("Audio context is suspended, attempting to resume...");
                Howler.ctx.resume().then(() => {
                    console.log("âœ… Audio context resumed successfully");
                }).catch(error => {
                    console.error("âŒ Failed to resume audio context:", error);
                });
            }
        }

        // è°ƒæ•´å¤§å°å‡½æ•° - æ”¹å›åˆå§‹ç‰ˆæœ¬
        var resize = function () {
            var width = waveform.clientWidth;
            var height = (window.innerHeight > 0) ? window.innerHeight * 0.2 : screen.height * 0.2;
            waveform.style.bottom = (height * 0.1 + 90) + 'px';
            canvas.width = width;
            canvas.height = height;
            
            // Update the position of the slider.
            var sound = player.playlist[player.index].howl;
            if (sound) {
                var vol = sound.volume();
                var barWidth = (vol * 0.9);
                sliderBtn.style.left = (window.innerWidth * barWidth + window.innerWidth * 0.05 - 25) + 'px';
                
                if (vudio) {
                    vudio.width = width;
                    vudio.height = height;
                    var accuracy = (width < 550) ? 32 : (width < 1000) ? 64 : 128;
                    vudio.setOption({
                        accuracy: accuracy,
                        waveform: {
                            maxHeight: height / 10 * 9,
                        }
                    });
                }
            }
        };

        // éŸ³é‡æ‹–åŠ¨å‡½æ•° - æ”¹å›åˆå§‹ç‰ˆæœ¬
        var move = function (event) {
            if (window.sliderDown) {
                var x = event.clientX || event.touches[0].clientX;
                var startX = window.innerWidth * 0.05;
                var layerX = x - startX;
                var per = Math.min(1, Math.max(0, layerX / parseFloat(barEmpty.scrollWidth)));
                player.volume(per);
            }
        };

        // åˆå§‹åŒ–æ’­æ”¾å™¨
        function initializePlayer() {
            firebase.database().ref('games').once('value').then(function (games) {
                var gameObj = games.val();
                if (!gameObj) {
                    console.error("æ— æ³•ä»FirebaseåŠ è½½æ¸¸æˆæ•°æ®");
                    return;
                }

                gameObj.forEach(game => {
                    // æ·»åŠ æ¸¸æˆæ ‡é¢˜
                    songList.push({
                        title: game.name,
                        file: null,
                        code: game.path.replace('/audio/', '').replace('.', '')
                    });

                    // æ·»åŠ æ­Œæ›² - ä½¿ç”¨æ­£ç¡®çš„éŸ³é¢‘URL
                    if (game.songs) {
                        game.songs.forEach(song => {
                            var songTitle = song.name.split(".")[1];
                            if (songTitle == ' U') {
                                songTitle = ' U.N.ã‚ªãƒ¼ã‚¨ãƒ³ã¯å½¼å¥³ãªã®ã‹ï¼Ÿ';
                            }
                            
                            // æ„å»ºæ­£ç¡®çš„éŸ³é¢‘URL - ä½¿ç”¨ GitHub Raw URL
                            var audioPath = song.path.replace('/audio/', 'audio/');
                            var audioUrl = AUDIO_BASE_URL + audioPath;
                            
                            songList.push({
                                title: songTitle,
                                file: audioUrl,  // ä½¿ç”¨å®Œæ•´çš„ Raw GitHub URL
                                howl: null,
                                info: song
                            });
                        });
                    }
                });

                // åˆ›å»ºæ’­æ”¾å™¨å®ä¾‹
                player = new Player(songList);
                console.log("æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆï¼Œæ­Œæ›²æ•°é‡:", songList.length);
                console.log("ç¤ºä¾‹éŸ³é¢‘URL:", songList.find(s => s.file)?.file);

                // ç»‘å®šäº‹ä»¶
                bindPlayerEvents();

                // è‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€é¦–æ­Œ
                setTimeout(() => {
                    if (player) {
                        console.log("ğŸµ Auto-playing first song...");
                        player.play();
                    }
                }, 1000);

            }).catch(function(error) {
                console.error("Firebaseæ•°æ®åŠ è½½å¤±è´¥:", error);
            });
        }

        // ç»‘å®šæ’­æ”¾å™¨äº‹ä»¶
        function bindPlayerEvents() {
            if (playBtn) {
                playBtn.onclick = () => {
                    console.log("â–¶ï¸ Play button clicked");
                    forceResumeAudioContext();
                    safePlayerCall(() => player.play());
                };
            }
            
            if (pauseBtn) pauseBtn.onclick = () => safePlayerCall(() => player.pause());
            if (prevBtn) prevBtn.onclick = () => safePlayerCall(() => player.skip('prev'));
            if (nextBtn) nextBtn.onclick = () => safePlayerCall(() => player.skip('next'));
            if (playlistBtn) playlistBtn.onclick = () => safePlayerCall(() => player.togglePlaylist());
            if (settingBtn) settingBtn.onclick = () => safePlayerCall(() => player.toggleSetting());
            if (volumeBtn) volumeBtn.onclick = () => safePlayerCall(() => player.toggleVolume());
            
            var closePlaylist = document.getElementById('closePlaylist');
            if (closePlaylist) closePlaylist.onclick = () => safePlayerCall(() => player.togglePlaylist());

            // æ³¢å½¢å›¾ç‚¹å‡»äº‹ä»¶
            if (waveform) {
                waveform.onclick = (event) => {
                    safePlayerCall(() => {
                        var percent = event.clientX / window.innerWidth;
                        player.seek(percent);
                    });
                };
            }

            // éŸ³é‡æ§åˆ¶ - ç‚¹å‡»éŸ³é‡æ¡ - æ”¹å›åˆå§‹ç‰ˆæœ¬
            if (barEmpty) {
                barEmpty.addEventListener('click', function (event) {
                    var per = event.layerX / parseFloat(barEmpty.scrollWidth);
                    player.volume(per);
                });
            }

            // éŸ³é‡æ»‘å—æ‹–åŠ¨ - æ”¹å›åˆå§‹ç‰ˆæœ¬
            if (sliderBtn) {
                sliderBtn.addEventListener('mousedown', function () {
                    window.sliderDown = true;
                });
                sliderBtn.addEventListener('touchstart', function () {
                    window.sliderDown = true;
                });
            }

            if (volume) {
                volume.addEventListener('mousemove', move);
                volume.addEventListener('touchmove', move);
                volume.addEventListener('mouseup', function () {
                    window.sliderDown = false;
                });
                volume.addEventListener('touchend', function () {
                    window.sliderDown = false;
                });
            }

            // ä¿®å¤ï¼šç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­éŸ³é‡æ§åˆ¶
            document.addEventListener('click', function(event) {
                if (volume && volume.style.display === 'block') {
                    // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨éŸ³é‡æ§åˆ¶åŒºåŸŸå¤–
                    var isClickInsideVolume = volume.contains(event.target);
                    var isClickOnVolumeBtn = volumeBtn.contains(event.target);
                    
                    if (!isClickInsideVolume && !isClickOnVolumeBtn) {
                        player.toggleVolume();
                    }
                }

                // åŒæ ·ä¿®å¤è®¾ç½®é¢æ¿
                if (setting && setting.style.display === 'block') {
                    var isClickInsideSetting = setting.contains(event.target);
                    var isClickOnSettingBtn = settingBtn.contains(event.target);
                    
                    if (!isClickInsideSetting && !isClickOnSettingBtn) {
                        player.toggleSetting();
                    }
                }

                // åŒæ ·ä¿®å¤æ’­æ”¾åˆ—è¡¨
                if (playlist && playlist.style.display === 'block') {
                    var isClickInsidePlaylist = playlist.contains(event.target);
                    var isClickOnPlaylistBtn = playlistBtn.contains(event.target);
                    var isClickOnCloseBtn = event.target.id === 'closePlaylist' || event.target.closest('#closePlaylist');
                    
                    if (!isClickInsidePlaylist && !isClickOnPlaylistBtn && !isClickOnCloseBtn) {
                        player.togglePlaylist();
                    }
                }
            });
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ğŸš€ Initializing player...");
            initializePlayer();
            window.addEventListener('resize', resize);
            
            // è®¾ç½®åˆå§‹éŸ³é‡
            Howler.volume(0.7);
            
            // æ·»åŠ ç”¨æˆ·äº¤äº’ç›‘å¬ä»¥æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡
            document.addEventListener('click', function() {
                forceResumeAudioContext();
            });
        });

    </script>

<script>
    // æ·»åŠ ESCé”®è¿”å›åŠŸèƒ½
    document.addEventListener('keydown', function(event) {
        if (event.keyCode === 27) { // ESCé”®
            closeAllModals();
        }
    });

    function closeAllModals() {
        if (playlist && playlist.style.display === 'block') {
            player.togglePlaylist();
        }
        if (setting && setting.style.display === 'block') {
            player.toggleSetting();
        }
        if (volume && volume.style.display === 'block') {
            player.toggleVolume();
        }
    }

    // ä¿®æ”¹ç°æœ‰çš„Playerç±»æ–¹æ³•
    Player.prototype.togglePlaylist = function () {
        if (!playlist) return;
        var isVisible = playlist.style.display === 'block';
        playlist.style.display = isVisible ? 'none' : 'block';
        
        if (!isVisible) {
            setTimeout(() => {
                if (playlist) {
                    playlist.setAttribute('tabindex', '-1');
                    playlist.focus();
                }
            }, 100);
        }
    };

    Player.prototype.toggleVolume = function () {
        if (!volume) return;
        var isVisible = volume.style.display === 'block';
        volume.style.display = isVisible ? 'none' : 'block';
        
        if (!isVisible) {
            setTimeout(() => {
                if (volume) {
                    volume.setAttribute('tabindex', '-1');
                    volume.focus();
                }
            }, 100);
        }
    };

    Player.prototype.toggleSetting = function () {
        if (!setting) return;
        var isVisible = setting.style.display === 'block';
        setting.style.display = isVisible ? 'none' : 'block';
        
        if (!isVisible) {
            setTimeout(() => {
                if (setting) {
                    setting.setAttribute('tabindex', '-1');
                    setting.focus();
                }
            }, 100);
        }
    };

    // é¡µé¢åŠ è½½æ—¶ä¸ºå¼¹çª—å…ƒç´ æ·»åŠ tabindex
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            if (playlist) playlist.setAttribute('tabindex', '-1');
            if (setting) setting.setAttribute('tabindex', '-1');
            if (volume) volume.setAttribute('tabindex', '-1');
        }, 1000);
    });
</script>    

</body>
</html>